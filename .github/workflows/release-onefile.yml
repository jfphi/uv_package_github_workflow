# ä»¥ Nuitka å°‡ uv å°ˆæ¡ˆçš„ main.py æ‰“åŒ…æˆå–®ä¸€å¯åŸ·è¡Œæª” (onefile)ï¼Œä¸¦æ–¼å»ºç«‹ tag æ™‚è‡ªå‹•ç”¢ç”Ÿ Release èˆ‡ä¸Šå‚³ç”¢ç‰©
name: Build and Release (Onefile)

on:
  push:
    tags:
      - 'v*'

jobs:
  build-onefile:
    runs-on: ubuntu-22.04  # é‡å° GLIBC 2.35 çš„ç›¸å®¹ç’°å¢ƒ
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      - name: Install uv
        uses: astral-sh/setup-uv@v1
        with:
          version: "0.8.3"

      - name: Install system dependencies
        run: |
          echo "ðŸ”§ Installing system dependencies for Ubuntu 22.04..."
          sudo apt update

          echo "ðŸ“¦ Adding deadsnakes PPA for Python 3.12..."
          sudo apt install -y software-properties-common
          sudo add-apt-repository -y ppa:deadsnakes/ppa
          sudo apt update

          echo "ðŸ Installing Python 3.12 and dev packages..."
          sudo apt install -y python3.12 python3.12-dev python3.12-venv

          echo "ðŸ”§ Installing build tools..."
          sudo apt install -y patchelf ccache build-essential binutils

          echo "âœ… System dependencies installed (python3.12-dev, patchelf, ccache, build-essential)"
          echo "ðŸ” GLIBC version: $(ldd --version | head -1)"
          echo "ðŸ Python 3.12 version (system): $(python3.12 --version)"

      - name: Install project dependencies with uv
        run: |
          echo "ðŸ“¦ Installing Python project dependencies via uv..."
          uv sync
          echo "âœ… Project dependencies installed"

      - name: Show build environment
        run: |
          echo "ðŸ” Build Environment Info:"
          echo "OS: Ubuntu 22.04 (GLIBC 2.35)"
          echo "GLIBC version: $(ldd --version | head -1)"
          echo "Default Python: $(python --version)"
          echo "Python 3.12: $(python3.12 --version 2>/dev/null || echo 'Not installed')"
          echo "uv: $(uv --version)"
          echo "patchelf: $(patchelf --version)"
          echo "ccache: $(ccache --version)"
          echo "Python 3.12 headers: $(ls /usr/include/python3.12/Python.h 2>/dev/null && echo 'Found' || echo 'Not found')"
          echo "Current directory: $(pwd)"
          ls -la

      - name: Get Git version info
        id: git_version
        run: |
          echo "ðŸ“‹ Getting Git version information..."
          echo "tag=$(git describe --tags --abbrev=0)" >> $GITHUB_OUTPUT
          echo "commit=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          echo "branch=$(git rev-parse --abbrev-ref HEAD)" >> $GITHUB_OUTPUT
          echo "date=$(git log -1 --format=%cd --date=short)" >> $GITHUB_OUTPUT
          echo "full_version=$(git describe --tags --abbrev=0)-$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

          echo "âœ… Git version info:"
          echo "  Tag: ${{ steps.git_version.outputs.tag }}"
          echo "  Commit: ${{ steps.git_version.outputs.commit }}"
          echo "  Branch: ${{ steps.git_version.outputs.branch }}"
          echo "  Date: ${{ steps.git_version.outputs.date }}"
          echo "  Full Version: ${{ steps.git_version.outputs.full_version }}"

      - name: Build onefile with Nuitka
        run: |
          set -e
          echo "ðŸš€ Building onefile with Nuitka on Ubuntu 22.04..."
          echo "ðŸ“¦ Version: ${{ steps.git_version.outputs.full_version }}"
          echo "ðŸ”§ Target GLIBC compatibility: 2.35+ (Ubuntu 22.04+)"

          echo "ðŸ” Verifying dependencies before build..."
          echo "GLIBC version: $(ldd --version | head -1)"
          echo "Python 3.12 binary: $(which python3.12 && echo 'OK' || echo 'MISSING')"
          echo "Python 3.12 version: $(python3.12 --version)"
          echo "Python 3.12 headers: $(ls /usr/include/python3.12/Python.h && echo 'OK' || echo 'MISSING')"
          echo "ccache: $(which ccache && echo 'OK' || echo 'MISSING')"
          echo "patchelf: $(which patchelf && echo 'OK' || echo 'MISSING')"

          echo "ðŸ“¦ Ensuring Nuitka is installed via uv..."
          uv pip install --python 3.12 "nuitka>=2.0"

          echo "ðŸ“¦ Injecting version information if script exists..."
          if [ -f "scripts/inject_version.py" ]; then
            python3.12 scripts/inject_version.py
          else
            echo "(skip) scripts/inject_version.py not found"
          fi

          echo "ðŸ§¹ Cleaning dist directory..."
          rm -rf dist
          mkdir -p dist

          echo "ðŸ› ï¸ Starting Nuitka onefile build..."
          # é è¨­å‡è¨­ main.py åœ¨ repository æ ¹ç›®éŒ„ï¼Œè‹¥å°ˆæ¡ˆä¸åŒè«‹èª¿æ•´æ­¤è·¯å¾‘
          python3.12 -m nuitka \
            --onefile \
            --standalone \
            --assume-yes-for-downloads \
            --follow-imports \
            --output-filename=dist/jfpy \
            main.py

          echo "ðŸ“Š Build Results:"
          ls -lh dist/
          echo "ðŸ” Checking GLIBC compatibility:"
          objdump -T dist/jfpy | grep GLIBC | sort -u | tail -5 || true
          echo "âœ… Nuitka onefile build successful"

      - name: Verify build
        run: |
          echo "ðŸ” Verifying build..."
          if [ -f "dist/jfpy" ]; then
            echo "âœ… Executable found: dist/jfpy"
            echo "ðŸ“ File size: $(ls -lh dist/jfpy | awk '{print $5}')"
            echo "ðŸ” File permissions: $(ls -la dist/jfpy | awk '{print $1}')"
            echo "ðŸ”— Dynamic libraries: $(ldd dist/jfpy | wc -l) dependencies"
            echo "ðŸ“‹ Basic functionality test:"
            ./dist/jfpy --help > /dev/null && echo "âœ… Help command works" || echo "âš ï¸ Help command may not be available"
          else
            echo "âŒ Executable not found!"
            exit 1
          fi

      - name: Get file size
        id: file_size
        run: |
          echo "size=$(ls -lh dist/jfpy | awk '{print $5}')" >> $GITHUB_OUTPUT
          echo "File size: $(ls -lh dist/jfpy | awk '{print $5}')"

      - name: Create Release
        uses: softprops/action-gh-release@v1
        id: create_release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref_name }}
          name: ${{ github.ref_name }}
          body: |
            # JF ç³»çµ±ç®¡ç†è…³æœ¬ (Onefile) - ${{ github.ref_name }}

            ## ðŸš€ åŠŸèƒ½ç‰¹è‰²
            - ä½¿ç”¨ Nuitka (ç¤¾å€ç‰ˆ) onefile æ‰“åŒ…
            - Linux x86_64 å–®ä¸€å¯åŸ·è¡Œæª”æ¡ˆ
            - ç›¸å®¹ GLIBC 2.35+ ç³»çµ± (Ubuntu 22.04+ ç›¸å®¹)
            - ä»¥ uv å®‰è£å°ˆæ¡ˆä¾è³´ä¸¦æ‰“åŒ…

            ## ðŸ“¦ å®‰è£èªªæ˜Ž
            1. ä¸‹è¼‰ `jfpy` å¯åŸ·è¡Œæª”æ¡ˆ
            2. çµ¦äºˆåŸ·è¡Œæ¬Šé™: `chmod +x jfpy`
            3. åŸ·è¡Œ: `./jfpy`

            ## ðŸ”§ æ§‹å»ºä¿¡æ¯
            - **Python ç‰ˆæœ¬**: 3.12
            - **Nuitka ç‰ˆæœ¬**: ç¤¾å€ç‰ˆ (onefile)
            - **æ§‹å»ºæ—¥æœŸ**: ${{ github.event.head_commit.timestamp }}
            - **æäº¤å“ˆå¸Œ**: ${{ github.sha }}
            - **æª”æ¡ˆå¤§å°**: ${{ steps.file_size.outputs.size }}
            - **ç›¸å®¹æ€§**: GLIBC 2.35+ (Ubuntu 22.04+ ç›¸å®¹)

            ## ðŸŽ¯ ä¸»è¦åŠŸèƒ½
            - ç³»çµ±åŸºç¤Žå®‰è£
            - NVIDIA/AMD é©…å‹•å®‰è£
            - Docker é…ç½®
            - ç³»çµ±ç›£æŽ§å·¥å…·
            - ç¡¬ç¢Ÿæ¸¬è©¦
            - Ceph æ¨¡åž‹æŽ›è¼‰

            ## ðŸ“ æ›´æ–°æ—¥èªŒ
            è«‹æŸ¥çœ‹ [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md) äº†è§£è©³ç´°æ›´æ–°å…§å®¹ã€‚
          draft: false
          prerelease: false
          files: dist/jfpy

      # --- ä»¥ä¸‹ç‚ºæŽ¨é€åˆ°å…¶ä»– public repo çš„æµç¨‹ï¼Œä¾éœ€æ±‚ä¿ç•™ä½†å…ˆè¨»è§£é—œé–‰ ---
      # - name: Setup Git for public repo
      #   run: |
      #     echo "ðŸ”§ Setting up Git for public repository..."
      #     git config --global user.name "github-actions[bot]"
      #     git config --global user.email "github-actions[bot]@users.noreply.github.com"

      # - name: Clone public repository
      #   run: |
      #     echo "ðŸ“¥ Cloning public repository..."
      #     git clone https://x-access-token:${{ secrets.PUBLIC_REPO_TOKEN }}@github.com/jfphi/jfpy-public.git public-repo
      #     cd public-repo
      #     echo "âœ… Public repository cloned"

      # - name: Update public repository
      #   run: |
      #     echo "ðŸ“ Updating public repository..."
      #     cd public-repo
      #
      #     # è¤‡è£½å·²æ§‹å»ºçš„ jfpy æª”æ¡ˆ
      #     cp ../dist/jfpy ./jfpy
      #     chmod +x ./jfpy
      #
      #     # æ›´æ–° README.md
      #     cat > README.md << 'EOF'
      #     # JF ç³»çµ±ç®¡ç†è…³æœ¬ - å…¬é–‹ç‰ˆæœ¬ (Onefile)
      #
      #     ## ðŸ“¦ æœ€æ–°ç‰ˆæœ¬
      #     - **ç‰ˆæœ¬**: ${{ github.ref_name }}
      #     - **æ§‹å»ºæ—¥æœŸ**: ${{ github.event.head_commit.timestamp }}
      #     - **æäº¤å“ˆå¸Œ**: ${{ github.sha }}
      #     - **æª”æ¡ˆå¤§å°**: ${{ steps.file_size.outputs.size }}
      #
      #     ## ðŸš€ åŠŸèƒ½ç‰¹è‰²
      #     - ä½¿ç”¨ Nuitka (ç¤¾å€ç‰ˆ) onefile æ‰“åŒ…
      #     - Linux x86_64 å–®ä¸€å¯åŸ·è¡Œæª”æ¡ˆ
      #     - ç›¸å®¹ GLIBC 2.35+ ç³»çµ±
      #     - ä»¥ uv å®‰è£å°ˆæ¡ˆä¾è³´ä¸¦æ‰“åŒ…
      #
      #     ## ðŸ“¦ å®‰è£èªªæ˜Ž
      #     1. ä¸‹è¼‰ `jfpy` å¯åŸ·è¡Œæª”æ¡ˆ
      #     2. çµ¦äºˆåŸ·è¡Œæ¬Šé™: `chmod +x jfpy`
      #     3. åŸ·è¡Œ: `./jfpy`
      #
      #     ## ðŸŽ¯ ä¸»è¦åŠŸèƒ½
      #     - ç³»çµ±åŸºç¤Žå®‰è£
      #     - NVIDIA/AMD é©…å‹•å®‰è£
      #     - Docker é…ç½®
      #     - ç³»çµ±ç›£æŽ§å·¥å…·
      #     - ç¡¬ç¢Ÿæ¸¬è©¦
      #     - Ceph æ¨¡åž‹æŽ›è¼‰
      #
      #     ## ðŸ“ æ›´æ–°æ—¥èªŒ
      #     è«‹æŸ¥çœ‹ [CHANGELOG.md](https://github.com/jfphi/jfpy/blob/main/CHANGELOG.md) äº†è§£è©³ç´°æ›´æ–°å…§å®¹ã€‚
      #     EOF
      #
      #     echo "âœ… Files updated in public repository"

      # - name: Commit and push to public repository
      #   run: |
      #     echo "ðŸ“¤ Committing and pushing to public repository..."
      #     cd public-repo
      #
      #     git add .
      #     git commit -m "Release ${{ github.ref_name }} - ${{ github.sha }}"
      #     git tag ${{ github.ref_name }}
      #     git push origin main
      #     git push origin ${{ github.ref_name }}
      #
      #     echo "âœ… Public repository updated and tagged"

      # - name: Verify files before public release
      #   run: |
      #     echo "ðŸ” Verifying files before creating public release..."
      #     echo "Current directory: $(pwd)"
      #     echo "Files in current directory:"
      #     ls -la
      #     echo "Files in public-repo directory:"
      #     ls -la public-repo/
      #     echo "Checking if jfpy exists in public-repo:"
      #     if [ -f "public-repo/jfpy" ]; then
      #       echo "âœ… jfpy file found in public-repo/"
      #       echo "File size: $(ls -lh public-repo/jfpy | awk '{print $5}')"
      #     else
      #       echo "âŒ jfpy file not found in public-repo/"
      #       exit 1
      #     fi

      # - name: Create Release in public repository
      #   uses: softprops/action-gh-release@v1
      #   env:
      #     GITHUB_TOKEN: ${{ secrets.PUBLIC_REPO_TOKEN }}
      #   with:
      #     repository: jfphi/jfpy-public
      #     tag_name: ${{ github.ref_name }}
      #     name: ${{ github.ref_name }}
      #     body: |
      #       # JF ç³»çµ±ç®¡ç†è…³æœ¬ (Onefile) - ${{ github.ref_name }}
      #
      #       ## ðŸš€ åŠŸèƒ½ç‰¹è‰²
      #       - ä½¿ç”¨ Nuitka (ç¤¾å€ç‰ˆ) onefile æ‰“åŒ…
      #       - Linux x86_64 å–®ä¸€å¯åŸ·è¡Œæª”æ¡ˆ
      #       - ç›¸å®¹ GLIBC 2.35+ ç³»çµ± (Ubuntu 22.04+ ç›¸å®¹)
      #       - ä»¥ uv å®‰è£å°ˆæ¡ˆä¾è³´ä¸¦æ‰“åŒ…
      #
      #       ## ðŸ“¦ å®‰è£èªªæ˜Ž
      #       1. ä¸‹è¼‰ `jfpy` å¯åŸ·è¡Œæª”æ¡ˆ
      #       2. çµ¦äºˆåŸ·è¡Œæ¬Šé™: `chmod +x jfpy`
      #       3. åŸ·è¡Œ: `./jfpy`
      #
      #       ## ðŸ”§ æ§‹å»ºä¿¡æ¯
      #       - **Python ç‰ˆæœ¬**: 3.12
      #       - **Nuitka ç‰ˆæœ¬**: ç¤¾å€ç‰ˆ (onefile)
      #       - **æ§‹å»ºæ—¥æœŸ**: ${{ github.event.head_commit.timestamp }}
      #       - **æäº¤å“ˆå¸Œ**: ${{ github.sha }}
      #       - **æª”æ¡ˆå¤§å°**: ${{ steps.file_size.outputs.size }}
      #       - **ç›¸å®¹æ€§**: GLIBC 2.35+ (Ubuntu 22.04+ ç›¸å®¹)
      #
      #       ## ðŸŽ¯ ä¸»è¦åŠŸèƒ½
      #       - ç³»çµ±åŸºç¤Žå®‰è£
      #       - NVIDIA/AMD é©…å‹•å®‰è£
      #       - Docker é…ç½®
      #       - ç³»çµ±ç›£æŽ§å·¥å…·
      #       - ç¡¬ç¢Ÿæ¸¬è©¦
      #       - Ceph æ¨¡åž‹æŽ›è¼‰
      #
      #       ## ðŸ“ æ›´æ–°æ—¥èªŒ
      #       è«‹æŸ¥çœ‹ [CHANGELOG.md](https://github.com/jfphi/jfpy/blob/main/CHANGELOG.md) äº†è§£è©³ç´°æ›´æ–°å…§å®¹ã€‚
      #     draft: false
      #     prerelease: false
      #     files: public-repo/jfpy

      - name: Build Summary
        run: |
          echo "ðŸŽ‰ Build and Release (Onefile) Summary:"
          echo "âœ… Ubuntu 22.04 environment setup (GLIBC 2.35 compatibility)"
          echo "âœ… Python 3.12 environment setup"
          echo "âœ… System dependencies installed (patchelf, python3.12-dev, ccache)"
          echo "âœ… Project dependencies installed via uv"
          echo "âœ… Nuitka onefile build completed"
          echo "âœ… Private repository release created"
          echo "ðŸ”— Tag: ${{ github.ref_name }}"
          echo "ðŸ“¦ Release URL: https://github.com/${{ github.repository }}/releases/tag/${{ github.ref_name }}"




